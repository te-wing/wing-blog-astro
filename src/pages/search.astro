---
import ErrorOnSearch from '../components/ErrorOnSearch.astro';
import Layout from '../layouts/Layout.astro';

let errorMessage = null;
let query = null;

try {
  const url = new URL(Astro.request.url);
  const token = url.searchParams.get('token');
  query = url.searchParams.get('q');

  const res = await fetch('https://challenges.cloudflare.com/turnstile/v0/siteverify', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      secret: import.meta.env.TURNSTILE_SECRET_KEY,
      response: token,
      remoteip: Astro.request.headers.get('x-forwarded-for') ?? ''
    })
  });

  const result = await res.json();

  if (!result.success) {
    errorMessage = '無効なTurnstileトークンです。';
  }
} catch (err) {
  errorMessage = 'トークン検証中にエラーが発生しました。';
}
---
{errorMessage ? (
  <ErrorOnSearch message={errorMessage} />
) : (
  <Layout>
  <h1>🔍 検索結果: {query}</h1>
  </Layout>
)}